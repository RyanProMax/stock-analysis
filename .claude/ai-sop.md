# AI 工作流程 (SOP)

## 工作原则

1. **先理解，后动手** - 修改代码前必须先阅读相关文件
2. **小步迭代** - 拆分任务，逐步实现，每步验证
3. **保持架构** - 遵循现有分层和模式，不破坏结构
4. **测试先行** - 修改后手动测试相关功能

## 通用流程

```
1. 理解任务
   │
   ├─ 用户要做什么？
   ├─ 涉及哪些模块？
   └─ 是否需要澄清需求？
   │
   ▼
2. 分析代码
   │
   ├─ 使用 Glob/Grep 定位文件
   ├─ 使用 Read 阅读关键代码
   ├─ 理解现有实现
   └─ 识别影响范围
   │
   ▼
3. 制定计划
   │
   ├─ 使用 TodoWrite 列出任务
   ├─ 按依赖关系排序
   └─ 预估风险点
   │
   ▼
4. 执行修改
   │
   ├─ 逐个完成任务
   ├─ 及时标记完成状态
   └─ 遇到问题暂停思考
   │
   ▼
5. 验证结果
   │
   ├─ 运行相关命令测试
   ├─ 检查是否有副作用
   └─ 确认符合预期
```

## 各类型任务 SOP

### Bug 修复

```
1. 定位问题
   │
   ├─ 询问复现步骤
   ├─ 查看相关日志/错误信息
   ├─ 使用 Grep 搜索可能出错的位置
   └─ Read 阅读相关代码
   │
   ▼
2. 分析根因
   │
   ├─ 理解代码逻辑
   ├─ 识别异常路径
   └─ 确定修复方案
   │
   ▼
3. 实施修复
   │
   ├─ Edit 修改代码（最小改动）
   ├─ 保持原有架构
   └─ 添加必要注释
   │
   ▼
4. 验证
   │
   ├─ 复查修复代码
   └─ 建议用户测试
```

### 新增功能

```
1. 需求确认
   │
   ├─ 使用 AskUserQuestion 澄清不明确的需求
   ├─ 确认技术方案选择
   └─ 确认验收标准
   │
   ▼
2. 设计方案
   │
   ├─ 确定需要修改的文件
   ├─ 确定新增的文件
   ├─ 检查是否需要新类型/接口
   └─ 评估对现有功能的影响
   │
   ▼
3. 实现功能
   │
   ├─ 先实现数据层（如有）
   ├─ 再实现业务层
   ├─ 然后实现 API/Controller
   └─ 最后实现前端（如需）
   │
   ▼
4. 测试验证
   │
   ├─ 启动服务
   ├─ 手动测试新功能
   └─ 检查相关功能是否正常
```

### 重构任务

```
1. 理解现状
   │
   ├─ Read 阅读要重构的代码
   ├─ 理解为什么要重构
   └─ 确认重构目标
   │
   ▼
2. 制定计划
   │
   ├─ 列出重构步骤
   ├─ 确保向后兼容（如需）
   └─ 规划测试策略
   │
   ▼
3. 执行重构
   │
   ├─ 小步迭代
   ├─ 保持功能等价
   └─ 及时更新类型/接口
   │
   ▼
4. 验证
   │
   ├─ 运行现有测试
   ├─ 手动测试相关功能
   └─ 对比重构前后行为
```

### 代码探索

```
1. 明确目标
   │
   └─ 用户想了解什么？
   │
   ▼
2. 选择工具
   │
   ├─ 单个文件 → Read
   ├─ 简单搜索 → Grep
   ├─ 模式匹配 → Glob
   └─ 复杂探索 → Task (Explore agent)
   │
   ▼
3. 分析总结
   │
   ├─ 提取关键信息
   ├─ 关联文件路径 (file:line)
   └─ 用简洁的语言解释
```

## 工具使用指南

### 文件操作

| 操作 | 工具 | 说明 |
|------|------|------|
| 读取文件 | Read | 必须先用 Read 再 Edit |
| 修改文件 | Edit | 替换已有内容 |
| 创建文件 | Write | 仅在必要时创建新文件 |
| 搜索文件 | Glob | 按模式查找文件 |
| 搜索内容 | Grep | 在文件中搜索代码 |

### 任务管理

| 操作 | 工具 | 说明 |
|------|------|------|
| 创建任务 | TodoWrite | 任务数 ≥3 时使用 |
| 更新状态 | TodoWrite | 完成后立即标记 |
| 并行任务 | Task | 多个独立任务并行执行 |

### 用户交互

| 场景 | 工具 | 说明 |
|------|------|------|
| 需求澄清 | AskUserQuestion | 2-4 个选项 |
| 大型实现 | EnterPlanMode | 需要规划时使用 |

## 常见模式

### 修改 Agent

```python
# 1. Read 先读 agent 文件
Read /path/to/agent.py

# 2. Edit 修改 analyze 方法
Edit agent.py old_string new_string

# 3. 检查相关代码
Grep "AgentName" --检查引用
```

### 新增因子

```python
# 1. Read 因子基类
Read server/src/indicators/base.py

# 2. Read 参考现有因子
Read server/src/indicators/technical_factors.py

# 3. 在对应库中添加新因子
Edit technical_factors.py ...

# 4. 更新 get_factors 方法
```

### 前端组件修改

```typescript
// 1. Read 组件文件
Read web/src/components/xxx/index.tsx

// 2. Read 类型定义
Read web/src/types/index.ts

// 3. Edit 修改组件
Edit index.tsx ...
```

## 注意事项

1. **不使用 Bash 进行文件操作**
   - 读文件用 Read，不用 cat
   - 改文件用 Edit，不用 sed
   - 写文件用 Write，不用 echo

2. **不假设，要验证**
   - 不确定文件内容时先 Read
   - 不确定影响范围时先 Grep
   - 修改后建议用户测试

3. **保持沟通简洁**
   - 输出直接有效
   - 不过度解释
   - 关键信息用代码块

4. **环境感知**
   - 开发环境 max_tokens=500
   - 生产环境无限制
   - 检查 is_development() 状态

5. **错误处理**
   - Agent 不抛异常，用 state.set_error
   - 尽量不用 try-catch / try-except，从根源上解决问题
   - API 返回统一格式
   - 前端 try-catch 所有调用
